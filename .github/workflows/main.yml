name: Build OpenWrt Package

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release'
        required: false
        default: false
        type: boolean

env:
  OPENWRT_VERSION: '24.10.5'
  TARGET: 'mediatek/filogic'
  ARCH: 'aarch64_cortex-a53'
  PACKAGE_NAME: 'adblock'
  SDK_URL: 'https://downloads.openwrt.org/releases/24.10.5/targets/mediatek/filogic/openwrt-sdk-24.10.5-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst'

jobs:
  build:
    name: Build adblock package
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
            python3-setuptools rsync swig unzip zlib1g-dev file wget \
            qemu-utils zstd

      - name: Download OpenWrt SDK
        run: |
          wget -q "${SDK_URL}" -O openwrt-sdk.tar.zst
          zstd -d openwrt-sdk.tar.zst
          tar -xf openwrt-sdk.tar
          mv openwrt-sdk-* openwrt-sdk
          rm -f openwrt-sdk.tar openwrt-sdk.tar.zst

      - name: Prepare package directories
        run: |
          # Prepare adblock package
          mkdir -p openwrt-sdk/package/adblock
          cp -r Makefile files openwrt-sdk/package/adblock/
          
          # Prepare luci-app-adblock package
          mkdir -p openwrt-sdk/package/luci-app-adblock
          cp -r luci-app-adblock/* openwrt-sdk/package/luci-app-adblock/

      - name: Update feeds
        working-directory: openwrt-sdk
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure build
        working-directory: openwrt-sdk
        run: |
          echo "CONFIG_PACKAGE_adblock=m" > .config
          echo "CONFIG_PACKAGE_luci-app-adblock=m" >> .config
          make defconfig

      - name: Build packages
        working-directory: openwrt-sdk
        run: |
          make package/adblock/compile V=s -j$(nproc)
          make package/luci-app-adblock/compile V=s -j$(nproc)

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          find openwrt-sdk/bin/packages/ -name "adblock*.ipk" -exec cp {} artifacts/ \;
          find openwrt-sdk/bin/packages/ -name "luci-app-adblock*.ipk" -exec cp {} artifacts/ \;
          find openwrt-sdk/bin/targets/ -name "adblock*.ipk" -exec cp {} artifacts/ \;
          find openwrt-sdk/bin/targets/ -name "luci-app-adblock*.ipk" -exec cp {} artifacts/ \;
          ls -lh artifacts/

      - name: Generate checksums
        working-directory: artifacts
        run: |
          sha256sum *.ipk > sha256sums.txt
          cat sha256sums.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: openwrt-packages-${{ env.ARCH }}-${{ env.OPENWRT_VERSION }}
          path: artifacts/*
          retention-days: 30
          compression-level: 9

      - name: Create Release
        if: github.event.inputs.create_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.OPENWRT_VERSION }}-build${{ github.run_number }}
          name: adblock ${{ env.OPENWRT_VERSION }} (Build ${{ github.run_number }})
          draft: false
          prerelease: false
          files: artifacts/*
          body: |
            ## OpenWrt Packages Release
            
            **Packages:** adblock + luci-app-adblock
            **Version:** ${{ env.OPENWRT_VERSION }}
            **Target:** ${{ env.TARGET }}
            **Architecture:** ${{ env.ARCH }}
            **Build:** #${{ github.run_number }}
            **Date:** ${{ github.event.repository.updated_at }}
            
            ### üì¶ Installation
            
            Download both `.ipk` files and install:
            
            ```bash
            # Transfer to router
            scp adblock_*.ipk luci-app-adblock_*.ipk root@192.168.1.1:/tmp/
            
            # SSH to router and install
            ssh root@192.168.1.1
            opkg install /tmp/adblock_*.ipk
            opkg install /tmp/luci-app-adblock_*.ipk
            ```
            
            ### ‚úÖ Verification
            
            Verify package integrity:
            ```bash
            sha256sum -c sha256sums.txt
            ```
            
            ### üìã Files in this release
            - `adblock_*.ipk` - Main backend package
            - `luci-app-adblock_*.ipk` - LuCI web interface
            - `sha256sums.txt` - Checksums for verification
            
            ### üîß Configuration
            
            After installation, configure in LuCI:
            - Navigate to **Services** ‚Üí **Adblock**
            - Enable the service
            - Select feeds and save
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload to Release (fallback)
        if: github.event.inputs.create_release != 'true'
        run: |
          echo "‚ö†Ô∏è  Release creation was disabled in workflow inputs"
          echo "‚úÖ Artifacts are available in the Actions tab"
          echo ""
          echo "To create a release:"
          echo "1. Go to Actions ‚Üí Build OpenWrt Package"
          echo "2. Click 'Run workflow'"
          echo "3. Check 'Create GitHub Release'"
          echo "4. Click 'Run workflow' button"
