name: Build OpenWrt Package

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  OPENWRT_VERSION: '24.10.5'
  TARGET: 'mediatek/filogic'
  ARCH: 'aarch64_cortex-a53'
  PACKAGE_NAME: 'adblock'
  SDK_URL: 'https://downloads.openwrt.org/releases/24.10.5/targets/mediatek/filogic/openwrt-sdk-24.10.5-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst'

jobs:
  build:
    name: Build adblock package
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
            python3-setuptools rsync swig unzip zlib1g-dev file wget \
            qemu-utils zstd

      - name: Download OpenWrt SDK
        run: |
          wget -q "${SDK_URL}" -O openwrt-sdk.tar.zst
          zstd -d openwrt-sdk.tar.zst
          tar -xf openwrt-sdk.tar
          mv openwrt-sdk-* openwrt-sdk
          rm -f openwrt-sdk.tar openwrt-sdk.tar.zst

      - name: Prepare package directory
        run: |
          mkdir -p openwrt-sdk/package/${PACKAGE_NAME}
          cp -r Makefile files openwrt-sdk/package/${PACKAGE_NAME}/

      - name: Update feeds
        working-directory: openwrt-sdk
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure build
        working-directory: openwrt-sdk
        run: |
          echo "CONFIG_PACKAGE_${PACKAGE_NAME}=m" > .config
          make defconfig

      - name: Build package
        working-directory: openwrt-sdk
        run: |
          make package/${PACKAGE_NAME}/compile V=s -j$(nproc)

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          find openwrt-sdk/bin/packages/ -name "${PACKAGE_NAME}*.ipk" -exec cp {} artifacts/ \;
          find openwrt-sdk/bin/targets/ -name "${PACKAGE_NAME}*.ipk" -exec cp {} artifacts/ \;
          ls -lh artifacts/

      - name: Generate checksums
        working-directory: artifacts
        run: |
          sha256sum *.ipk > sha256sums.txt
          cat sha256sums.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}-${{ env.ARCH }}-openwrt-${{ env.OPENWRT_VERSION }}
          path: artifacts/*
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
          body: |
            ## OpenWrt Package Release
            
            **Package:** ${{ env.PACKAGE_NAME }}
            **Version:** ${{ env.OPENWRT_VERSION }}
            **Target:** ${{ env.TARGET }}
            **Architecture:** ${{ env.ARCH }}
            
            ### Installation
            ```bash
            opkg install ${{ env.PACKAGE_NAME }}_*.ipk
            ```
            
            ### Files
            - Package: `.ipk` file
            - Checksums: `sha256sums.txt`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
